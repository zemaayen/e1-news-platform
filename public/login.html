<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E1 - Ethiopia News Website</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 200'%3E%3Ccircle cx='100' cy='100' r='100' fill='%23e30613'/%3E%3Ctext x='100' y='140' font-family='Times New Roman,serif' font-size='120' font-weight='900' fill='white' text-anchor='middle' letter-spacing='-5'%3EE1%3C/text%3E%3C/svg%3E">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="login-container">
        <div class="login-box">
            <div style="text-align: center; margin-bottom: 30px;">
                <div class="login-brand">
                    <img src="" alt="Logo" class="site-logo" id="siteLogo" style="display: none; max-height: 90px; max-width: 250px; margin: 0 auto 15px;">
                    <div class="logo-wrapper">
                        <div class="logo-main">
                            <span class="logo-text" id="siteName">E1</span>
                        </div>
                        <span class="logo-subtitle">NEWS</span>
                    </div>
                </div>
            </div>
            <h2 class="text-center mb-20" style="color: #666;">Welcome Back</h2>
            
            <div id="alert" class="alert hidden"></div>

            <form id="loginForm">
                <div class="form-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" class="form-control" required>
                </div>

                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" class="form-control" required>
                </div>

                <button type="submit" class="btn btn-primary" style="width: 100%;">Login</button>
            </form>

            <div class="text-center mt-20">
                <a href="/" style="color: var(--primary-color); text-decoration: none;">← Back to Homepage</a>
            </div>
        </div>
    </div>

    <script>
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const alert = document.getElementById('alert');

            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password }),
                    credentials: 'include'
                });

                const data = await response.json();

                if (response.ok) {
                    alert.className = 'alert alert-success';
                    alert.textContent = 'Login successful! Redirecting...';
                    alert.classList.remove('hidden');

                    // Redirect based on role
                    setTimeout(() => {
                        if (data.user.role === 'superadmin') {
                            window.location.href = '/superadmin';
                        } else if (data.user.role === 'reporter') {
                            window.location.href = '/reporter';
                        } else if (data.user.role === 'user') {
                            window.location.href = '/user';
                        } else {
                            window.location.href = '/';
                        }
                    }, 1000);
                } else {
                    alert.className = 'alert alert-error';
                    alert.textContent = data.error || 'Login failed';
                    alert.classList.remove('hidden');
                }
            } catch (error) {
                alert.className = 'alert alert-error';
                alert.textContent = 'Connection error. Please try again.';
                alert.classList.remove('hidden');
            }
        });

        // Quick login buttons for demo
        function quickLogin(username, password) {
            document.getElementById('username').value = username;
            document.getElementById('password').value = password;
        }

        // ========== LOAD AND APPLY SITE SETTINGS ==========
        async function loadSiteSettings() {
            try {
                const response = await fetch('/api/settings');
                const data = await response.json();
                const settings = data.settings;
                
                // Apply site name
                const siteName = settings.siteName || 'MebratuGobeze';
                document.title = `Login - ${siteName}`;
                
                // Create initials for E1-style logo (e.g., "MebratuGobeze" -> "MG")
                const siteNameElement = document.getElementById('siteName');
                if (siteNameElement) {
                    // Extract initials from site name (first letters of each word)
                    const words = siteName.split(/[\s-]+/);
                    let initials = '';
                    
                    if (words.length === 1) {
                        // If single word, take first 2 characters
                        initials = siteName.substring(0, 2).toUpperCase();
                    } else {
                        // If multiple words, take first letter of each word (max 3)
                        initials = words
                            .slice(0, 3)
                            .map(word => word.charAt(0).toUpperCase())
                            .join('');
                    }
                    
                    // Special cases: check for common multi-word formats
                    if (siteName.toLowerCase().includes('news') && words.length > 1) {
                        // Try to get a meaningful abbreviation
                        const nonNewsWords = words.filter(w => w.toLowerCase() !== 'news');
                        if (nonNewsWords.length > 0) {
                            initials = nonNewsWords[0].substring(0, 2).toUpperCase();
                        }
                    }
                    
                    siteNameElement.textContent = initials;
                }
                
                // Apply logo
                const logoElement = document.getElementById('siteLogo');
                if (logoElement) {
                    if (settings.logo) {
                        logoElement.src = settings.logo;
                        logoElement.style.display = 'block';
                        logoElement.onerror = function() {
                            this.style.display = 'none';
                        };
                    } else {
                        logoElement.style.display = 'none';
                    }
                }
                
                // Apply primary color as CSS variable
                if (settings.primaryColor) {
                    document.documentElement.style.setProperty('--primary-color', settings.primaryColor);
                    document.documentElement.style.setProperty('--n12-red', settings.primaryColor);
                }
                
                console.log('✅ [LOGIN PAGE] Site settings loaded:', settings);
            } catch (error) {
                console.error('[LOGIN PAGE] Error loading site settings:', error);
            }
        }
        
        // Load settings on page load
        loadSiteSettings();
    </script>
</body>
</html>

